
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Pratos - Reserva</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
      color: #333;
    }

    h2 {
      margin-top: 20px;
      color: #444;
    }

    .formulario, #telaPratos {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    #listaPratos ul {
      list-style-type: none;
      padding-left: 0;
      margin-bottom: 15px;
    }

    #listaPratos li {
      margin: 5px 0;
    }

    input[type="text"] {
      padding: 6px;
      width: 250px;
      margin-right: 10px;
    }

    button {
      padding: 8px 16px;
      background-color: #2a8df4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #006edc;
    }
  </style>
</head>
<body>

  <button onclick="verPratos()">Ver pratos</button>

  <div class="formulario">
    <input type="text" id="nomeCliente" placeholder="Seu nome">
    <button onclick="enviarReserva()">Reservar</button>
  </div>

  <div id="telaPratos" style="display:none;">
    <h2>Pratos disponíveis</h2>
    <div id="listaPratos"></div>
    <div id="botoesReserva" style="margin-top: 20px;">
      <button onclick="confirmarReserva()">Confirmar Reserva</button>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbysVvVdkCHTq772jeLDOIqiwolmKH1AjlzCH-DGFFGIx3bwzRA0smuyeNvTNn099LLW/exec";

    let pratosSelecionados = [];

    function verPratos() {
      console.log("verPratos() chamada");
      document.getElementById('telaPratos').style.display = 'block';
      document.querySelector('.formulario').style.display = 'none';
      document.getElementById('botoesReserva').style.display = 'block';
      carregarPratos();
    }

    function carregarPratos() {
      fetch(`${scriptURL}?modo=pratos`)
        .then(response => response.json())
        .then(data => {
          const lista = document.getElementById('listaPratos');
          lista.innerHTML = '';
          pratosSelecionados = [];

          for (const dia in data) {
            const ul = document.createElement('ul');
            ul.innerHTML = `<strong>${dia}</strong>`;
            data[dia].forEach(prato => {
              const li = document.createElement('li');
              li.innerHTML = `
                <label>
                  <input type="checkbox" onchange="selecionarPrato(this, '${prato.prato || prato.nome}', '${dia}')">
                  ${prato.prato || prato.nome}
                </label>`;
              ul.appendChild(li);
            });
            lista.appendChild(ul);
          }
        });
    }

    function selecionarPrato(checkbox, nome, dia) {
      if (checkbox.checked) {
        pratosSelecionados.push({ nome, diaSemana: dia });
      } else {
        pratosSelecionados = pratosSelecionados.filter(p => !(p.nome === nome && p.diaSemana === dia));
      }
      console.log("Selecionados:", pratosSelecionados);
    }

    function enviarReserva() {
      const nome = document.getElementById("nomeCliente").value;
      enviarReservaParaSheets(nome, pratosSelecionados);
    }

    function confirmarReserva() {
      const nome = document.getElementById("nomeCliente").value;
      enviarReservaParaSheets(nome, pratosSelecionados);
    }

    function enviarReservaParaSheets(nomeCliente, pratosSelecionados) {
      console.log("Função enviarReservaParaSheets chamada.");
      console.log("Nome do cliente:", nomeCliente);
      console.log("Pratos selecionados:", pratosSelecionados);

      if (!nomeCliente || !pratosSelecionados || !pratosSelecionados.length) {
        alert('Preencha o nome e selecione pelo menos um prato.');
        return;
      }

      Promise.all(pratosSelecionados.map(pratoObj => {
        const dados = {
          nome: nomeCliente,
          prato: pratoObj.nome,
          diaSemana: pratoObj.dia || pratoObj.diaSemana,
          modo: "reserva"
        };

        console.log("A enviar:", dados);

        return fetch(scriptURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(dados)
        })
          .then(response => {
            if (!response.ok) throw new Error("Network error");
            return response.json();
          })
          .then(data => {
            console.log("Resposta JSON:", data);
            if (!data.sucesso) throw new Error("Backend error");
          });
      }))
      .then(() => {
        alert('Reserva enviada com sucesso!');
        document.getElementById('telaPratos').style.display = 'none';
        document.querySelector('.formulario').style.display = 'block';
        document.getElementById('botoesReserva').style.display = 'none';
      })
      .catch((err) => {
        console.error("Erro ao enviar reserva:", err);
        alert('Erro ao enviar reserva: ' + err.message);
      });
    }
  </script>

</body>
</html>
